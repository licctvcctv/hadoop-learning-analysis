# ============================================
# Flume配置文件
# 基于Hadoop的大学生线上课程学习行为数据存储与分析系统
# 采集学习行为日志到HDFS
# ============================================

# 定义Agent组件
agent.sources = spooldir-source
agent.channels = memory-channel
agent.sinks = hdfs-sink

# ==================== Source配置 ====================
# 使用Spooling Directory Source监控日志目录
agent.sources.spooldir-source.type = spooldir
agent.sources.spooldir-source.spoolDir = /data/logs
agent.sources.spooldir-source.fileSuffix = .COMPLETED
agent.sources.spooldir-source.fileHeader = true
agent.sources.spooldir-source.fileHeaderKey = filename
agent.sources.spooldir-source.basenameHeader = true
agent.sources.spooldir-source.basenameHeaderKey = basename
agent.sources.spooldir-source.deserializer = LINE
agent.sources.spooldir-source.deserializer.maxLineLength = 10240
agent.sources.spooldir-source.batchSize = 100
agent.sources.spooldir-source.inputCharset = UTF-8
agent.sources.spooldir-source.decodeErrorPolicy = IGNORE

# 拦截器 - 添加时间戳
agent.sources.spooldir-source.interceptors = timestamp-interceptor
agent.sources.spooldir-source.interceptors.timestamp-interceptor.type = timestamp
agent.sources.spooldir-source.interceptors.timestamp-interceptor.preserveExisting = false

# 绑定Channel
agent.sources.spooldir-source.channels = memory-channel

# ==================== Channel配置 ====================
# 使用Memory Channel
agent.channels.memory-channel.type = memory
agent.channels.memory-channel.capacity = 10000
agent.channels.memory-channel.transactionCapacity = 1000
agent.channels.memory-channel.byteCapacityBufferPercentage = 20
agent.channels.memory-channel.byteCapacity = 800000

# ==================== Sink配置 ====================
# HDFS Sink - 按日期分区存储
agent.sinks.hdfs-sink.type = hdfs
agent.sinks.hdfs-sink.hdfs.path = hdfs://namenode:9000/user/learning_behavior/raw/year=%Y/month=%m/day=%d
agent.sinks.hdfs-sink.hdfs.filePrefix = learning_behavior
agent.sinks.hdfs-sink.hdfs.fileSuffix = .log
agent.sinks.hdfs-sink.hdfs.fileType = DataStream
agent.sinks.hdfs-sink.hdfs.writeFormat = Text

# 滚动策略
agent.sinks.hdfs-sink.hdfs.rollInterval = 3600
agent.sinks.hdfs-sink.hdfs.rollSize = 134217728
agent.sinks.hdfs-sink.hdfs.rollCount = 0
agent.sinks.hdfs-sink.hdfs.idleTimeout = 60

# 批量写入
agent.sinks.hdfs-sink.hdfs.batchSize = 100

# 时间配置
agent.sinks.hdfs-sink.hdfs.useLocalTimeStamp = true
agent.sinks.hdfs-sink.hdfs.timeZone = Asia/Shanghai

# 副本数
agent.sinks.hdfs-sink.hdfs.minBlockReplicas = 1

# 绑定Channel
agent.sinks.hdfs-sink.channel = memory-channel
